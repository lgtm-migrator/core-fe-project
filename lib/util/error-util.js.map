{"version":3,"file":"error-util.js","sourceRoot":"","sources":["../../src/util/error-util.ts"],"names":[],"mappings":";AAAA,OAAO,EAAC,SAAS,EAAE,mBAAmB,EAAC,MAAM,cAAc,CAAC;AAE5D,OAAO,EAAC,GAAG,EAAC,MAAM,QAAQ,CAAC;AAC3B,OAAO,EAAC,WAAW,EAAC,MAAM,kBAAkB,CAAC;AAC7C,OAAO,EAAC,KAAK,EAAC,MAAM,eAAe,CAAC;AACpC,OAAO,EAAC,mBAAmB,EAAE,+BAA+B,EAAE,aAAa,EAAC,MAAM,uBAAuB,CAAC;AAE1G,IAAI,mBAAmB,GAAG,KAAK,CAAC;AAOhC,MAAM,UAAU,gBAAgB,CAAC,KAAc;IAC3C,IAAI,KAAK,YAAY,SAAS,EAAE;QAC5B,OAAO,KAAK,CAAC;KAChB;SAAM;QACH,IAAI,OAAO,SAAQ,CAAC;QACpB,IAAI,CAAC,KAAK,EAAE;YACR,OAAO,GAAG,cAAc,CAAC;SAC5B;aAAM,IAAI,OAAO,KAAK,KAAK,QAAQ,EAAE;YAClC,OAAO,GAAG,KAAK,CAAC;SACnB;aAAM,IAAI,KAAK,YAAY,KAAK,EAAE;YAC/B,OAAO,GAAG,KAAK,CAAC,OAAO,CAAC;SAC3B;aAAM;YACH,IAAI;gBACA,OAAO,GAAG,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;aACnC;YAAC,OAAO,CAAC,EAAE;gBACR,OAAO,GAAG,WAAW,CAAC;aACzB;SACJ;QACD,OAAO,IAAI,mBAAmB,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC;KAClD;AACL,CAAC;AAED,MAAM,UAAU,YAAY,CAAC,KAAc,EAAE,MAAc,EAAE,KAAsB;IAAtB,sBAAA,EAAA,UAAsB;IAC/E,IAAI,OAAO,CAAC,GAAG,CAAC,QAAQ,KAAK,aAAa,EAAE;QACxC,OAAO,CAAC,KAAK,CAAC,2CAAoC,MAAM,MAAG,EAAE,KAAK,CAAC,CAAC;KACvE;IAED,IAAM,SAAS,GAAG,gBAAgB,CAAC,KAAK,CAAC,CAAC;IAC1C,IAAM,eAAe,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,SAAS,CAAC;IACzE,IAAM,IAAI,GAAwC;QAC9C,OAAO,EAAE,KAAK,CAAC,aAAa;QAC5B,gBAAgB,EAAE,KAAK,CAAC,eAAe;QACvC,UAAU,EAAE,eAAe;KAC9B,CAAC;IAEF,IAAM,SAAS,GAAG,gBAAgB,CAAC,SAAS,EAAE,MAAM,EAAE,eAAe,CAAC,CAAC;IACvE,IAAI,SAAS,EAAE;QACX,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC;YACZ,MAAM,QAAA;YACN,WAAW,EAAE,CAAC;YACd,IAAI,MAAA;YACJ,YAAY,EAAE,SAAS,CAAC,OAAO;YAC/B,SAAS,WAAA;SACZ,CAAC,CAAC;KACN;SAAM;QACH,GAAG,CAAC,MAAM,CAAC,SAAS,CAAC,SAAS,EAAE,IAAI,EAAE,MAAM,CAAC,CAAC;QAC9C,GAAG,CAAC,cAAc,CAAC,GAAG,CAAC,mBAAmB,EAAE,GAAG,CAAC,YAAY,EAAE,SAAS,CAAC,CAAC;KAC5E;IAED,OAAO,SAAS,CAAC;AACrB,CAAC;AAED,MAAM,UAAW,mBAAmB,CAAC,OAAqB,EAAE,SAAoB;;;;;YAC5E,6EAA6E;YAC7E,qBAAM,KAAK,CAAC,aAAa,CAAC,EAAA;;gBAD1B,6EAA6E;gBAC7E,SAA0B,CAAC;gBAC3B,IAAI,mBAAmB;oBAAE,sBAAO;;;;gBAG5B,mBAAmB,GAAG,IAAI,CAAC;gBAC3B,sBAAA,SAAO,OAAO,CAAC,SAAS,CAAC,CAAA,EAAA;;gBAAzB,SAAyB,CAAC;;;;gBAE1B,OAAO,CAAC,IAAI,CAAC,2CAA2C,EAAE,GAAC,CAAC,CAAC;;;gBAE7D,mBAAmB,GAAG,KAAK,CAAC;;;;;CAEnC;AAED,SAAS,gBAAgB,CAAC,SAAoB,EAAE,MAAc,EAAE,UAAmB;IAC/E,IAAM,YAAY,GAAG,SAAS,CAAC,OAAO,CAAC,WAAW,EAAE,CAAC;IACrD,IAAM,eAAe,GAAG;QACpB,yEAAyE;QACzE,EAAC,OAAO,EAAE,eAAe,EAAE,SAAS,EAAE,UAAU,EAAC;QACjD,EAAC,OAAO,EAAE,mBAAmB,EAAE,SAAS,EAAE,WAAW,EAAC;QACtD,qBAAqB;QACrB,EAAC,OAAO,EAAE,yBAAyB,EAAE,SAAS,EAAE,KAAK,EAAC;QACtD,EAAC,OAAO,EAAE,cAAc,EAAE,SAAS,EAAE,MAAM,EAAC;QAC5C,gDAAgD;QAChD,EAAC,OAAO,EAAE,WAAW,EAAE,SAAS,EAAE,QAAQ,EAAC;QAC3C,EAAC,OAAO,EAAE,MAAM,EAAE,SAAS,EAAE,QAAQ,EAAC;QACtC,EAAC,OAAO,EAAE,QAAQ,EAAE,SAAS,EAAE,QAAQ,EAAC;QACxC,yBAAyB;QACzB,EAAC,OAAO,EAAE,2BAA2B,EAAE,SAAS,EAAE,eAAe,EAAC;QAClE,EAAC,OAAO,EAAE,oCAAoC,EAAE,SAAS,EAAE,eAAe,EAAC;KAC9E,CAAC;IAEF,IAAI,WAAW,EAAE,EAAE;QACf,OAAO,kBAAkB,CAAC;KAC7B;IAED,IAAM,cAAc,GAAG,eAAe,CAAC,IAAI,CAAC,UAAC,EAAS;YAAR,OAAO,aAAA;QAAM,OAAA,YAAY,CAAC,QAAQ,CAAC,OAAO,CAAC;IAA9B,CAA8B,CAAC,CAAC;IAC3F,IAAI,cAAc,EAAE;QAChB,OAAO,kBAAW,cAAc,CAAC,SAAS,WAAQ,CAAC;KACtD;IACD,IAAI,SAAS,YAAY,mBAAmB,IAAI,CAAC,iBAAiB,CAAC,UAAU,CAAC,IAAI,CAAC,mBAAmB,EAAE,+BAA+B,CAAC,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE;QACvJ,OAAO,6BAA6B,CAAC;KACxC;IACD,IAAI,MAAM,KAAK,mBAAmB,IAAI,UAAU,IAAI,YAAY,CAAC,QAAQ,CAAC,2BAA2B,CAAC,IAAI,UAAU,CAAC,QAAQ,CAAC,gBAAgB,CAAC,EAAE;QAC7I,OAAO,4BAA4B,CAAC;KACvC;IACD,OAAO,IAAI,CAAC;AAChB,CAAC;AAED,SAAS,iBAAiB,CAAC,UAAmB;IAC1C,IAAI,UAAU,EAAE;QACZ,IAAM,eAAe,GAAG,CAAC,qBAAqB,CAAC,CAAC;QAChD,IAAI,eAAe,CAAC,IAAI,CAAC,UAAC,CAAC,IAAK,OAAA,UAAU,CAAC,QAAQ,CAAC,CAAC,CAAC,EAAtB,CAAsB,CAAC,EAAE;YACrD,OAAO,KAAK,CAAC;SAChB;QAED;;;;;WAKG;QACH,OAAO,UAAU,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;KACrC;IACD,OAAO,KAAK,CAAC;AACjB,CAAC","sourcesContent":["import {Exception, JavaScriptException} from \"../Exception\";\nimport {ErrorHandler} from \"../module\";\nimport {app} from \"../app\";\nimport {isIEBrowser} from \"./navigator-util\";\nimport {spawn} from \"../typed-saga\";\nimport {GLOBAL_ERROR_ACTION, GLOBAL_PROMISE_REJECTION_ACTION, sendEventLogs} from \"../platform/bootstrap\";\n\nlet errorHandlerRunning = false;\n\ninterface ErrorExtra {\n    actionPayload?: string; // Should be masked\n    extraStacktrace?: string;\n}\n\nexport function errorToException(error: unknown): Exception {\n    if (error instanceof Exception) {\n        return error;\n    } else {\n        let message: string;\n        if (!error) {\n            message = \"[No Message]\";\n        } else if (typeof error === \"string\") {\n            message = error;\n        } else if (error instanceof Error) {\n            message = error.message;\n        } else {\n            try {\n                message = JSON.stringify(error);\n            } catch (e) {\n                message = \"[Unknown]\";\n            }\n        }\n        return new JavaScriptException(message, error);\n    }\n}\n\nexport function captureError(error: unknown, action: string, extra: ErrorExtra = {}): Exception {\n    if (process.env.NODE_ENV === \"development\") {\n        console.error(`[framework] Error captured from [${action}]`, error);\n    }\n\n    const exception = errorToException(error);\n    const errorStacktrace = error instanceof Error ? error.stack : undefined;\n    const info: {[key: string]: string | undefined} = {\n        payload: extra.actionPayload,\n        extra_stacktrace: extra.extraStacktrace,\n        stacktrace: errorStacktrace,\n    };\n\n    const errorCode = specialErrorCode(exception, action, errorStacktrace);\n    if (errorCode) {\n        app.logger.warn({\n            action,\n            elapsedTime: 0,\n            info,\n            errorMessage: exception.message,\n            errorCode,\n        });\n    } else {\n        app.logger.exception(exception, info, action);\n        app.sagaMiddleware.run(runUserErrorHandler, app.errorHandler, exception);\n    }\n\n    return exception;\n}\n\nexport function* runUserErrorHandler(handler: ErrorHandler, exception: Exception) {\n    // For app, report errors to event server ASAP, in case of sudden termination\n    yield spawn(sendEventLogs);\n    if (errorHandlerRunning) return;\n\n    try {\n        errorHandlerRunning = true;\n        yield* handler(exception);\n    } catch (e) {\n        console.warn(\"[framework] Fail to execute error handler\", e);\n    } finally {\n        errorHandlerRunning = false;\n    }\n}\n\nfunction specialErrorCode(exception: Exception, action: string, stacktrace?: string): string | null {\n    const errorMessage = exception.message.toLowerCase();\n    const ignoredPatterns = [\n        // Network error while downloading JavaScript/CSS (webpack async loading)\n        {pattern: \"loading chunk\", errorCode: \"JS_CHUNK\"},\n        {pattern: \"loading css chunk\", errorCode: \"CSS_CHUNK\"},\n        // CORS or CSP issues\n        {pattern: \"content security policy\", errorCode: \"CSP\"},\n        {pattern: \"script error\", errorCode: \"CORS\"},\n        // Vendor injected, mostly still with stacktrace\n        {pattern: \"ucbrowser\", errorCode: \"VENDOR\"},\n        {pattern: \"vivo\", errorCode: \"VENDOR\"},\n        {pattern: \"huawei\", errorCode: \"VENDOR\"},\n        // Browser sandbox issues\n        {pattern: \"the operation is insecure\", errorCode: \"BROWSER_LIMIT\"},\n        {pattern: \"access is denied for this document\", errorCode: \"BROWSER_LIMIT\"},\n    ];\n\n    if (isIEBrowser()) {\n        return \"IE_BROWSER_ISSUE\";\n    }\n\n    const matchedPattern = ignoredPatterns.find(({pattern}) => errorMessage.includes(pattern));\n    if (matchedPattern) {\n        return `IGNORED_${matchedPattern.errorCode}_ISSUE`;\n    }\n    if (exception instanceof JavaScriptException && !isValidStacktrace(stacktrace) && [GLOBAL_ERROR_ACTION, GLOBAL_PROMISE_REJECTION_ACTION].includes(action)) {\n        return \"IGNORED_UNCATEGORIZED_ISSUE\";\n    }\n    if (action === GLOBAL_ERROR_ACTION && stacktrace && errorMessage.includes(\"minified react error #188\") && stacktrace.includes(\"getRootDomNode\")) {\n        return \"IGNORED_ANTD_POPOVER_ISSUE\";\n    }\n    return null;\n}\n\nfunction isValidStacktrace(stacktrace?: string): boolean {\n    if (stacktrace) {\n        const ignoredPatterns = [\"chrome-extension://\"];\n        if (ignoredPatterns.some((_) => stacktrace.includes(_))) {\n            return false;\n        }\n\n        /**\n         * Use fuzzy search, instead of document.querySelectorAll(\"script\") to get all script tag URLs.\n         *\n         * The reason is, in latest webpack, the code-split chunk script is just injected and then removed.\n         * In other words, the <script> tag only exists temporarily, not persisted in the DOM.\n         */\n        return stacktrace.includes(\".js\");\n    }\n    return false;\n}\n"]}